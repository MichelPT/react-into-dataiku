<div id="webapp-container">
    <div id="loading-indicator" style="text-align: center; padding: 50px;">
        <h2>Loading Data Platform...</h2>
        <p>Please wait while the application loads.</p>
    </div>
    
    <div id="error-display" style="display: none; text-align: center; padding: 50px; color: red;">
        <h2>Unable to load application</h2>
        <p id="error-message"></p>
        <button onclick="retryLoad()">Retry</button>
    </div>
    
    <!-- Container for Next.js content (no iframe) -->
    <div id="nextjs-content" style="display: none; width: 100%; height: 100%;"></div>
</div>

<style>
body {
    margin: 0;
    padding: 0;
    font-family: system-ui, -apple-system, sans-serif;
}

#webapp-container {
    width: 100%;
    height: 100vh;
}

#loading-indicator {
    background: #f8f9fa;
}

#nextjs-content {
    overflow: auto;
}
</style>

<script>
console.log('Dataiku webapp body.html loading (no iframe approach)...');

let loadAttempts = 0;
const maxAttempts = 3;

function showError(message) {
    console.error('Error:', message);
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('nextjs-content').style.display = 'none';
    document.getElementById('error-display').style.display = 'block';
    document.getElementById('error-message').textContent = message;
}

function showSuccess() {
    console.log('Next.js app loaded successfully');
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('error-display').style.display = 'none';
    document.getElementById('nextjs-content').style.display = 'block';
}

function retryLoad() {
    if (loadAttempts < maxAttempts) {
        loadAttempts++;
        console.log('Retry attempt:', loadAttempts);
        document.getElementById('error-display').style.display = 'none';
        document.getElementById('loading-indicator').style.display = 'block';
        loadNextJsContent();
    } else {
        showError('Maximum retry attempts reached. Please refresh the page.');
    }
}

function fixAssetPaths(html) {
    // Replace all Next.js asset paths with relative paths
    return html
        .replace(/href="\/_next\//g, 'href="../../resources/out/_next/')
        .replace(/src="\/_next\//g, 'src="../../resources/out/_next/')
        .replace(/href="\/favicon\.ico"/g, 'href="../../resources/out/favicon.ico"')
        .replace(/content="\/"/g, 'content="../../resources/out/"')
        .replace(/"\/"/g, '"../../resources/out/"');
}

function loadNextJsContent() {
    const container = document.getElementById('nextjs-content');
    
    // Try different sources in order of preference
    const sources = [
        '../../resources/out/index.html',
        '../../resources/out/structures/index.html',
        '../../resources/out/dashboard/index.html'
    ];
    
    let currentSourceIndex = 0;
    
    function tryNextSource() {
        if (currentSourceIndex >= sources.length) {
            showError('All sources failed to load. Check if Next.js files are properly deployed.');
            return;
        }
        
        const source = sources[currentSourceIndex];
        console.log('Trying to load content from:', source);
        
        fetch(source)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                console.log('Successfully fetched HTML content');
                
                // Parse the HTML and extract body content
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Get the body content and fix asset paths
                let bodyContent = doc.body.innerHTML;
                bodyContent = fixAssetPaths(bodyContent);
                
                // Insert the content
                container.innerHTML = bodyContent;
                
                // Also need to add the head elements (CSS, scripts)
                const headElements = doc.head.querySelectorAll('link[rel="stylesheet"], script');
                headElements.forEach(element => {
                    const newElement = element.cloneNode(true);
                    
                    // Fix paths for head elements too
                    if (newElement.href) {
                        newElement.href = newElement.href.replace(/\/_next\//g, '../../resources/out/_next/');
                    }
                    if (newElement.src) {
                        newElement.src = newElement.src.replace(/\/_next\//g, '../../resources/out/_next/');
                    }
                    
                    document.head.appendChild(newElement);
                });
                
                console.log('Content injected successfully');
                showSuccess();
            })
            .catch(error => {
                console.error(`Failed to load source ${source}:`, error);
                currentSourceIndex++;
                
                if (currentSourceIndex < sources.length) {
                    console.log('Trying next source...');
                    setTimeout(tryNextSource, 1000);
                } else {
                    showError(`Failed to load content: ${error.message}`);
                }
            });
    }
    
    // Start with first source
    tryNextSource();
}

// Test if we can access the resources
function testResourceAccess() {
    console.log('Testing resource access...');
    
    fetch('../../resources/out/index.html')
        .then(response => {
            console.log('Resource test response:', response.status, response.statusText);
            if (response.ok) {
                console.log('Resources are accessible');
                loadNextJsContent();
            } else {
                showError('Resources not accessible. Status: ' + response.status);
            }
        })
        .catch(error => {
            console.error('Resource test failed:', error);
            showError('Cannot access Next.js resources: ' + error.message);
        });
}

// Initialize
setTimeout(function() {
    testResourceAccess();
}, 1000);
</script>