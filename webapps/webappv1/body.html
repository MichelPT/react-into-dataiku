<div id="webapp-container">
    <div id="loading-indicator" style="text-align: center; padding: 50px;">
        <h2>Loading Data Platform...</h2>
        <p>Please wait while the application loads.</p>
    </div>
    
    <div id="error-display" style="display: none; text-align: center; padding: 50px; color: red;">
        <h2>Unable to load application</h2>
        <p id="error-message"></p>
        <button onclick="retryLoad()">Retry</button>
    </div>
    
    <iframe 
        id="nextjs-iframe"
        src="../../resources/out/index.html" 
        width="100%" 
        height="700px" 
        frameborder="0"
        style="border: none; display: none;">
    </iframe>
</div>

<style>
body {
    margin: 0;
    padding: 0;
    font-family: system-ui, -apple-system, sans-serif;
}

#webapp-container {
    width: 100%;
    height: 100vh;
}

#loading-indicator {
    background: #f8f9fa;
}
</style>

<script>
console.log('Dataiku webapp body.html loading...');

let loadAttempts = 0;
const maxAttempts = 3;

function showError(message) {
    console.error('Error:', message);
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('nextjs-iframe').style.display = 'none';
    document.getElementById('error-display').style.display = 'block';
    document.getElementById('error-message').textContent = message;
}

function showSuccess() {
    console.log('Next.js app loaded successfully');
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('error-display').style.display = 'none';
    document.getElementById('nextjs-iframe').style.display = 'block';
}

function retryLoad() {
    if (loadAttempts < maxAttempts) {
        loadAttempts++;
        console.log('Retry attempt:', loadAttempts);
        document.getElementById('error-display').style.display = 'none';
        document.getElementById('loading-indicator').style.display = 'block';
        loadNextJsApp();
    } else {
        showError('Maximum retry attempts reached. Please refresh the page.');
    }
}

function loadNextJsApp() {
    const iframe = document.getElementById('nextjs-iframe');
    
    // Try different sources in order of preference
    const sources = [
        '../../resources/out/index-fixed.html',
        '../../resources/out/index.html',
        '../../resources/out/structures/index.html'
    ];
    
    let currentSourceIndex = 0;
    
    function tryNextSource() {
        if (currentSourceIndex >= sources.length) {
            showError('All sources failed to load. Check if Next.js files are properly deployed.');
            return;
        }
        
        const source = sources[currentSourceIndex];
        console.log('Trying source:', source);
        
        iframe.src = source;
        currentSourceIndex++;
    }
    
    iframe.onload = function() {
        console.log('Iframe loaded successfully');
        showSuccess();
    };
    
    iframe.onerror = function() {
        console.error('Iframe failed to load source:', iframe.src);
        tryNextSource();
    };
    
    // Timeout fallback
    setTimeout(function() {
        if (document.getElementById('loading-indicator').style.display !== 'none') {
            console.warn('Loading timeout, trying next source');
            tryNextSource();
        }
    }, 5000);
    
    // Start with first source
    tryNextSource();
}

// Test if we can access the resources
function testResourceAccess() {
    console.log('Testing resource access...');
    
    fetch('../../resources/out/index.html')
        .then(response => {
            console.log('Resource test response:', response.status, response.statusText);
            if (response.ok) {
                console.log('Resources are accessible');
                loadNextJsApp();
            } else {
                showError('Resources not accessible. Status: ' + response.status);
            }
        })
        .catch(error => {
            console.error('Resource test failed:', error);
            showError('Cannot access Next.js resources: ' + error.message);
        });
}

// Initialize
setTimeout(function() {
    testResourceAccess();
}, 1000);
</script>